<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <title>Document</title>
</head>
<style type="text/css">
    .pickdiv{
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid gray;
        display: inline-block;
    }
    #white{
        background: white;
    }
    #red{
        background:#ff6666;
    }
    #yellow{
        background:#ffff00;
    }
    #blue{
        background:#333399;
    }
    #green{
        background:#339933;
    }
    #cv_video{
        position: absolute;
        z-index: 1;
    }
    #barrageplayer{
        position: relative;
        display: inline-block;
        width: 900px;
        height: 500px;
        margin-right: 0;
    }
    #v_video{
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 0;
    }
    #user{
        width: 10%;
        height: 50px;
        line-height: 50px;
        font-size: 18px;
        display: inline-block;
    }
    #status{
        text-align: center;
        width: 70%;
        height: 50px;
        line-height: 50px;
        font-size: 18px;
        display: inline-block;
    }
    #back{
        text-align: center;
        width: 10%;
        height: 50px;
        line-height: 50px;
        font-size: 18px;
        display: inline-block;
    }

    #barragelist{
        position: absolute;
        height: 600px;
        width: 400px;
        background: #e7e7e7;
        top: 55px;
        right:40px;
        display: block;
    }
    #barragelist > #head{
        background: #e8e8e8;
        width: 100%;
        font-size: 16px;
        text-align: center;
        border: 1 solid #c0c0c0;
    }
    #contentwrapper{
        width: 100%;
        height: inherit;
        overflow: scroll;
    }
    #content{
        width: 100%;
        text-align: center;
    }
    #barragelist .b_content{
        width: 70%;
    }
    #barrageinput{
        margin-top: 10px;
        width: 900px;
    }
    #content .b_time{
        width: 30%;
    }
    #content .b_content{
        widows: 70%;
    }
    #barrageinput div{
        display: inline-block;
    }
    #inputtext{
        width: 100%;
    }
    #smsg{
        width:90%;
    }
    #send{
        width: 7%;
    }
    
</style>


<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <a class="navbar-brand">弹幕系统</a>
            <div id="back"><a>《回到点播</a></div>
            <div id="status">正在播放</div>
            <div id="user">
                <a href="#" id="login" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">登录|注册</a>
            </div>
        </div>
    </nav>
    <div id="barrageplayer">
        <canvas id="cv_video" width="900px" height="480px"></canvas>
        <video id="v_video" src="http://www.w3school.com.cn/example/html5/mov_bbb.mp4" controls type="video/mp4"></video>
    </div>
    <div id="barragelist">
        <table id="head" border="1">
            <tr>
                <td class="b_time">时间</td>
                <td class="b_content">弹幕内容</td>
            </tr>
        </table>
        <div id="contentwrapper">
            <table id="content">
            </table>
        </div>
        
    </div>
    <div id="barrageinput">
        <div id="inputtext">
            <input type="text" id="smsg" placeholder="请输入弹幕内容"/>
            <button id="send"> 发送</button>
        </div>
        <div id="colorpick">
            颜色：
            <div class="pickdiv" id="white"></div>
            <div class="pickdiv" id="red"></div>
            <div class="pickdiv" id="yellow"></div>
            <div class="pickdiv" id="blue"></div>
            <div class="pickdiv" id="green"></div>
        </div>|
        <div id="typepick">
            样式：
            <input type="radio" name="type" value="default">默认
            <input type="radio" name="type" value="static top">静止顶部 
            <input type="radio" name="type" value="static bottom">静止底部
        </div>|
        <div id="speedpick">
            速度：
            <input type="radio" name="speed" value="1">1X
            <input type="radio" name="speed" value="2">2X
            <input type="radio" name="speed" value="3">3X
        </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">注册登录</h4>
      </div>
      <div class="modal-body">
        <div>
            <ul id="myTab" class="nav nav-tabs">
                <li class="active">
                    <a href="#modal-login" data-toggle="tab">
                        登录
                    </a>
                </li>
                <li><a href="#modal-regist" data-toggle="tab">注册</a></li>
            </ul>
            <div id="myTabContent" class="tab-content">
                <div class="tab-pane fade in active" id="modal-login">
                    <h2 class="form-sigin-heading">登录</h2>
                    <label for="inputEmail" class="sr-only">账户</label>
                    <input type="text" class="form-control" placeholder="账户" id="loginusername" required autofocus>
                    <label for="inputPassword" class="sr-only">密码</label>
                    <input type="password" class="form-control" placeholder="密码" id="loginpassword" required>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" value="remember-me">
                            记住密码
                        </label>
                    </div>
                    <button class="btn btn-lg btn-primary btn-block" id="loginbutton" type="submit">登录</button>
                </div>
                <div class="tab-pane " id="modal-regist">
                    <h2 class="form-signin-heading">注册</h2>
                    <label for="inputEmail" class="sr-only">账户</label>
                    <input type="text" class="form-control" placeholder="账户" id="registusername" required autofocus>
                    <label for="inputPassword" class="sr-only">密码</label>
                    <input type="password" class="form-control" placeholder="密码（6位以上）" id="registpassword" required>
                    <input type="password" class="form-control" placeholder="确认密码" id="registpassword2" required>
                    <div>&nbsp;</div>
                    <button class="btn btn-lg btn-primary btn-block" id="registbutton" type="submit">注册</button>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        var guserName;
        var c=document.getElementById("cv_video");
        var v=document.getElementById("v_video");

        var typeDom=document.getElementsByName("type");
        var speedDom=document.getElementsByName("speed");
        var colorpick=document.getElementById("colorpick");
        var smsg=document.getElementById("smsg");

        var color="white";
        var speed=1;
        var type="default";
        var msgs=[];
        var timemsg=[];

        //获取画布大小
        var c_height=c.height;
        var c_width=c.width;

        //获取画布
        ctx=c.getContext("2d");
        ctx.font="25px DengXian";

        function clearYellow(){
            var colorPick=document.getElementsByClassName("pickdiv");
            for(var i=0;i<colorPick.length;i++){
                colorPick[i].style.borderColor="gray";
            }
        }
        //处理颜色选择
        colorpick.addEventListener('click',function(event){
            clearYellow();
            switch(event.target.id){
                case "white":
                    color="white";
                    event.target.style.borderColor="green";
                    break;
                case "red":
                    color="#ff6666";
                    event.target.style.borderColor="green";
                    break;
                case "yellow":
                    color="#ffff00";
                    event.target.style.borderColor="green";
                    break;
                case "green":
                    color="#339933";
                    event.target.style.borderColor="green";
                    break;
                case "blue":
                    color="#333399";
                    event.target.style.borderColor="green";
                    break;
            }
        })

        //获取XHR对象
        function createXHR(){
            if(typeof XMLHttpRequest !="undefined"){
                return new XMLHttpRequest();
            }else if(typeof ActiveXObject!="undefined"){
                if(typeof arguments.callee.activeXString!="string"){
                    var versions=["MSXML.XMLHttp.6.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp"],i,len;
                    for(i=0;len=versions.length;i++){
                        try{
                            new ActiveXObject(versions[i]);
                            arguments.callee.activeXString=versions[i];
                            bresk;
                        }catch(ex){
                            console.log(ex);
                        }
                    }
                }
                return new ActiveXObject(arguments.callee.activeXString);
            }
        }

        //处理发送弹幕
        document.getElementById("send").onclick=function(){
            var text=smsg.value;
            for(var i=0;i<typeDom.length;i++){
                if(typeDom[i].checked){
                    type=typeDom[i].value;
                    break;
                }
            }
            for(var i=0;i<speedDom.length;i++){
                if(speedDom[i].checked){
                    speed=2*parseInt(speedDom[i].value);
                    break;
                }
            }
            var tempBarrage=new Barrage(text,color,type,speed);
            msgs.push(tempBarrage);
            var timeBarrage=new TimestampBarrage(tempBarrage,new TimeStamp(Math.floor(v.currentTime)));
            sendBarrage(JSON.stringify(timeBarrage),guserName,0);
        }
        

        //
        //弹幕功能部分代码
        //
        //弹幕对象
        function Barrage(content,color,type,speed){
            this.content=content;
            this.color=color;
            this.type=type;
            this.speed=speed;

            if(this.type=="default"){
                this.height=parseInt(Math.random()*c_height)+10;
            }else if (this.type=="static top"){
                this.height=parseInt((c_height/2)-Math.random()*c_height/2)+10;
            }else if (this.type=="static bottom"){
                this.height=parseInt((c_height/2)+Math.random()*c_height/2)+10;
            }
            if(typeof this.move!="function"){
                Barrage.prototype.move=function(){
                    if(this.type=="default"){
                        this.left=this.left-this.speed;
                    }
                }
            }
        }

        function TimeStamp(time){
            this.time=time;
            this.seconds=time%60;   
            this.minute=Math.floor(time/60);
            this.hour=Math.floor(time/3600);
            if(typeof this.compare!="function"){
                TimeStamp.prototype.compare=function(timestamp){
                    if(this.time=timestamp.time) return true;
                    else return false;
                }
            }
        }

        //带时间戳弹幕对象
        function TimestampBarrage(barrage,timestamp){
            Barrage.call(this,barrage.content,barrage.color,barrage.type,barrage.speed);
            this.timestamp=timestamp;
        }
        var newprototype=Object(Barrage.prototype);
        newprototype.constructor=TimestampBarrage;
        TimestampBarrage.prototype=newprototype;



        

        //循环擦写画布实现动画效果
        setInterval(function(){
            ctx.clearRect(0,0,c_width,c_height);
            ctx.save();
            for(var i=0;i<msgs.length; i++){
                if(msgs[i]!=null){
                    if(msgs[i].type=="default"){
                        handleDefault(msgs[i]);
                    }else{
                        handleStatic(msgs[i]);
                    }
                }            
            }
        },20)

    //处理默认弹幕样式
    function handleDefault(barrage){
        if(barrage.left==undefined||barrage.left==null){
            barrage.left=c.width;
        }else{
             if(barrage.left<-200){
                barrage=null;
            }else{
                barrage.move()
                ctx.fillStyle=barrage.color;
                ctx.fillText(barrage.content,barrage.left,barrage.height)
                ctx.restore();
            }
        }  
    }

    //处理静止弹幕样式
    function handleStatic(barrage){
        ctx.moveTo(c_width/2,barrage.height);
        ctx.textAlign="center";
        ctx.fillStyle=barrage.color;
        ctx.fillText(barrage.content,c_width/2,barrage.height);
        if(barrage.left==undefined||barrage.left==null){
            barrage.left=c.width;
        }else{
            if(barrage.left<-200){
                ctx.fillText("",c_width/2,barrage.height);                
                barrage=null;
                //ctx.restore();
                ctx.clearRect(0,0,c_width,c_height);        
            }else{
                barrage.left=barrage.left-6;
            }
        }
    }
    
    //处理时间戳弹幕
    setInterval(function(){
        if(!v.paused){
            var getedmsgs=timemsg.filter(function(timebarrage){
                return timebarrage.timestamp.time==Math.floor(v.currentTime);
            })
            if(getedmsgs instanceof Array){
                for(var i=0;i<getedmsgs.length;i++){
                    msgs.push(getedmsgs[i]);
                }
            }else{
        
                msgs.push(getedmsgs);
            }
        }       
    },1000)

    //ajax交互部分
    function addUrlParam(url,name,value){
        url+=(url.indexOf("?")==-1?"?":"&");
        url+=encodeURIComponent(name)+"="+encodeURIComponent(value);
        return url;
    }

    function getBarrageList(){
        var xhr=createXHR();
        var url="/";
    }

    function sendBarrage(barrage,userName,id){
        var xhr=createXHR();
        var url="/barrage";
        url=addUrlParam(url,"videoid",id);
        url=addUrlParam(url,"barrage",barrage);
        url=addUrlParam(url,"name",userName);
        xhr.open("post",url,false);
        xhr.send(null);
    }

    function regisitUser(userName,password){
        var xhr=createXHR();
        var url="/user";
        url=addUrlParam(url,"name",userName);
        url=addUrlParam(url,"password",password);
        xhr.open("post",url,false);
        xhr.send(null);
        xhr.onreadystatechange=function(){
            if(xhr.readyState==4){
                if(xhr.status>=200&&shr.status<300||xhr.status==304){
                    if(xhr.responseText=="succeed"){
                        alert("注册成功");
                    }else{
                        alert("你的用户名已被注册");
                    }
                }
            }
        }
    }
    function changeUser(){
        var user=document.getElementById("user");
        user.innerHTML=guserName+" 已登录";
    }
    function login(userName,password){
        var xhr=createXHR();
        var url="/login";
        url=addUrlParam(url,"name",userName);
        url=addUrlParam(url,"password",password);
        xhr.open("post",url,false);
        xhr.send(null);
        xhr.onreadystatechange=function(){
            if(xhr.readyState==4){
                if(xhr.status>=200&&shr.status<300||xhr.status==304){
                    if(xhr.responseText=="pass"){
                        guserName=userName;
                    }else{
                        alert("密码或用户名错误");
                    }
                }
            }
        }
    }
    document.getElementById("loginbutton").addEventListener("click",function(e){
        var userName=document.getElementById("loginusername").value;
        var password=document.getElementById("loginpassword").value;
        login(userName,password);
    })
    $('#myTab a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })

    window.onload=function(){
        var testBarrage=new Barrage("nihao","white","default",4);
        for(var i=0;i<100;i++){
            for(var j=0;j<10;j++){
                timemsg.push(new TimestampBarrage(testBarrage,new TimeStamp(i*2)));     
            }
        }
        var table=document.getElementById("content");
        var content=table.innerHTML;
        for(var i=0;i<timemsg.length;i++){
            var timestamp=timemsg[i].timestamp;
            content+="<tr><td class='b_time'>"+timestamp.hour+":"+timestamp.minute+":"+timestamp.seconds+"</td>";
            content+="<td class='b_content'>"+timemsg[i].content+"</td></tr>";
        }
        table.innerHTML=content;

    }
    </script>
</body>
</html>